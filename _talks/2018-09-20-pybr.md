---
layout: slide
css: pybr14

event: üáßüá∑ &middot; 20/10/18 &middot; Python Brasil[14]
title: Reutilizando c√≥digo C no Python com CFFI

full: /images/fulls/pybr14.png
thumb: /images/fulls/pybr14.png
---

<section data-markdown><script type="text/template">
  {% include slides/components/image.html src="logos/pybr14.svg" width="35%" %}

  ## Reutilizando c√≥digo C
  # no Python
</script></section>

<section data-markdown data-transition="none"><script type="text/template">
  # Problema
  <br>
  - Muitas bibliotecas j√° est√£o implementadas em C/C++

  - ‚ù§Ô∏è e queremos codar em üêç / Precisamos codar em üêç
</script></section>

<section data-markdown data-transition="none"><script type="text/template">
  # Op√ß√µes
  <br>
  [ CPython | ctypes | cffi | Cython ]
</script></section>

<section data-markdown data-transition="none"><script type="text/template">
  # Op√ß√µes
  <br>
  [ CPython | ctypes | **cffi** | Cython ]
</script></section>

<section data-markdown data-transition="none"><script type="text/template">
  # Solu√ß√£o
</script></section>

<section data-transition="none">
<h2>binding code at _build_ffi.py</h2>

<pre><code class="python" data-trim data-noescape>
from distutils.util import get_platform
from cffi import FFI
from wolfcrypt import __wolfssl_version__ as version
from wolfcrypt._build_wolfssl import local_path

ffi = FFI()

ffi.set_source(
    "wolfcrypt._ffi",
    """
    #include <wolfssl/options.h>

    #include <wolfssl/wolfcrypt/random.h>
    """,
    include_dirs=[local_path("lib/wolfssl/src")],
    library_dirs=[local_path("lib/wolfssl/{}/{}/lib".format(
        get_platform(), version))],
    libraries=["wolfssl"],
)

ffi.cdef(
    """

    typedef unsigned char byte;
    typedef unsigned int word32;

    typedef struct { ...; } WC_RNG;

    int wc_InitRng(WC_RNG*);
    int wc_RNG_GenerateBlock(WC_RNG*, byte*, word32);
    int wc_RNG_GenerateByte(WC_RNG*, byte*);
    int wc_FreeRng(WC_RNG*);

    """
)

if __name__ == "__main__":
    ffi.compile(verbose=1)
</code></pre>
</section>

<section data-transition="none">
<h2>python class at random.py</h2>

<pre><code class="python" data-trim data-noescape>
from wolfcrypt._ffi import ffi as _ffi
from wolfcrypt._ffi import lib as _lib

from wolfcrypt.exceptions import WolfCryptError


class Random(object):
    """
    A Cryptographically Secure Pseudo Random Number Generator - CSPRNG
    """
    def __init__(self):
        self.native_object = _ffi.new("WC_RNG *")

        ret = _lib.wc_InitRng(self.native_object)
        if ret < 0:
            self.native_object = None
            raise WolfCryptError("RNG init error (%d)" % ret)

    def __del__(self):
        if self.native_object:
            try:
                _lib.wc_FreeRng(self.native_object)
            except AttributeError:
                # Can occur during interpreter shutdown
                pass

    def byte(self):
        """
        Generate and return a random byte.
        """
        result = _ffi.new('byte[1]')

        ret = _lib.wc_RNG_GenerateByte(self.native_object, result)
        if ret < 0:
            raise WolfCryptError("RNG generate byte error (%d)" % ret)

        return _ffi.buffer(result, 1)[:]

    def bytes(self, length):
        """
        Generate and return a random sequence of length bytes.
        """
        result = _ffi.new('byte[%d]' % length)

        ret = _lib.wc_RNG_GenerateBlock(self.native_object, result, length)
        if ret < 0:
            raise WolfCryptError("RNG generate block error (%d)" % ret)

        return _ffi.buffer(result, length)[:]
</code></pre>
</section>

<section data-transition="none">
<h2>python tests at test_random.py</h2>

<pre><code class="python" data-trim data-noescape>
import pytest
from wolfcrypt.random import Random


@pytest.fixture
def rng():
    return Random()


def test_byte(rng):
    assert len(rng.byte()) == 1


def test_bytes(rng):
    assert len(rng.bytes(1)) == 1
    assert len(rng.bytes(8)) == 8
    assert len(rng.bytes(128)) == 128
</code></pre>
</section>

<section data-transition="none">
<h2>testing</h2>

<pre><code class="yaml" data-trim data-noescape>
lint: ## check style with flake8
	flake8 src tests
	pylint src tests/*

test: install ## run tests quickly with the default Python
	py.test tests

check: test ## run tests quickly with the default Python

test-all: ## run tests on every Python version with tox
	tox

check-all: test-all ## run tests on every Python version with tox

cov: install ## check code coverage quickly with the default Python
	py.test --cov-config .coveragerc --cov=wolfcrypt tests
	coverage report -m
	coverage html
	$(BROWSER) htmlcov/index.html
</code></pre>
</section>

<section data-transition="none">
<h2>distributing on pypi</h2>

<pre><code class="yaml" data-trim data-noescape>
dist: clean ## builds source and wheel package
	python setup.py sdist
	
	./make/osx/build_wheels.sh

	./make/manylinux1/build_wheels.sh

	ls -l dist

release: ## package and upload a release
	twine upload dist/*
</code></pre>
</section>

<section data-transition="none">
<h2>travis config at _config.yml</h2>

<pre><code class="yaml" data-trim data-noescape>
sudo: required

branches:
  only:
    - master

matrix:
  include:
    - dist: trusty
      language: python
      services:
        - docker
      script:
        - ./make/manylinux1/build_wheels.sh
    - os: osx
      osx_image: xcode8.3
      script:
        - ./make/osx/build_wheels.sh

install:
  - if [ "${TRAVIS_OS_NAME:-}" == "osx" ]; then ./make/osx/install_python.sh; fi
</code></pre>
</section>

<section data-markdown data-transition="none"><script type="text/template">
  # Obrigado

  ## e vamos pro PyBar üç∫
</script></section>